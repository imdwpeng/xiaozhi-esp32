# ESP-SparkBot 飞行游戏使用指南

## 游戏概述

基于ESP32-S3的3个触摸按键开发的纵向飞行射击游戏，完全集成到xiaozhi-esp32系统中。

## 游戏特性

### 核心玩法
- **纵向卷轴射击游戏**
- **自动发射子弹系统**
- **敌人随机生成和AI**
- **碰撞检测和爆炸效果**
- **分数和生命值系统**
- **云朵背景装饰**

### 技术特点
- **基于LVGL的图形界面**
- **50Hz流畅刷新率**
- **模块化组件设计**
- **动态按键映射系统**
- **状态机管理**

## 按键控制方案

### 1. 初始状态
```
┌─────────────────────────────────┐
│     分数: 0     生命: ❤❤❤       │
│                                 │
│         按中间键开始游戏          │
│                                 │
│                                 │
└─────────────────────────────────┘
```
**按键功能**:
- 左键: 上一个屏幕 (系统功能)
- 右键: 下一个屏幕 (系统功能)
- 中键: 开始游戏

### 2. 游戏进行状态
```
┌─────────────────────────────────┐
│     分数: 120   生命: ❤❤❤       │
│         💫                        │
│      💥✈️💥                      │
│         ✨                        │
│      长按中间键暂停游戏            │
└─────────────────────────────────┘
```
**按键功能**:
- 左键: 飞机左移
- 右键: 飞机右移
- 中键(长按): 暂停游戏

### 3. 暂停状态
```
┌─────────────────────────────────┐
│     分数: 120   生命: ❤❤❤       │
│                                 │
│     按左键直接退出，按右键暂存退出  │
│                                 │
│                                 │
└─────────────────────────────────┘
```
**按键功能**:
- 左键: 直接退出游戏 (丢失进度)
- 右键: 暂存退出游戏 (保存进度)
- 中键: 继续游戏

## 游戏机制

### 对象类型
- **飞机** (✈️): 玩家控制，可以左右移动
- **子弹** (•): 自动向上发射
- **敌人** (👾): 从顶部随机位置下落
- **云朵** (☁️): 背景装饰，缓慢移动
- **爆炸** (💥): 碰撞特效

### 游戏规则
1. **躲避敌人**: 避免与敌人碰撞
2. **击落敌人**: 子弹击中敌人获得10分
3. **生命系统**: 初始3条生命，碰撞敌人减1条
4. **游戏结束**: 生命值归零时游戏结束

### 难度设计
- **敌人生成频率**: 每1.5秒生成一个
- **敌人速度**: 2-4像素/帧 (随机)
- **子弹发射频率**: 每0.5秒发射一发
- **屏幕对象限制**: 最多3个子弹，5个敌人，3个云朵

## 技术实现

### 文件结构
```
main/display/
├── flight_game_widget.h     # 游戏组件头文件
├── flight_game_widget.cc    # 游戏组件实现
├── screens.h                # 屏幕类定义 (已修改)
└── screens.cc               # 屏幕类实现 (已修改)

main/input/
├── simple_touch_manager.h   # 触摸管理器 (已修改)
└── simple_touch_manager.cc  # 触摸管理器实现 (已修改)

main/
└── CMakeLists.txt           # 构建配置 (已修改)
```

### 核心类
- **FlightGameWidget**: 游戏逻辑和UI管理
- **FlightGameScreen**: 屏幕包装类
- **SimpleTouchManager**: 触摸按键管理 (增强版)

### 状态机
```cpp
typedef enum {
    GAME_STATE_INIT = 0,     // 初始状态，等待开始
    GAME_STATE_PLAYING,      // 游戏进行中
    GAME_STATE_PAUSED        // 暂停/退出选择
} game_state_t;
```

### 按键模式
```cpp
// SimpleTouchManager 模式
Mode 0: 正常模式 (屏幕切换功能)
Mode 1: 游戏模式 (飞机控制功能)
Mode 2: 暂停模式 (退出选择功能)
```

## 集成方式

### 屏幕系统
- 飞行游戏作为第3个屏幕集成到系统中
- 与天气时钟屏幕、主屏幕并列
- 支持屏幕切换手势

### 按键系统
- **动态回调切换**: 根据游戏状态切换按键映射
- **无缝集成**: 不影响其他屏幕的按键功能
- **状态保持**: 退出游戏后自动恢复系统按键

### 资源管理
- **内存管理**: 使用智能指针管理对象
- **定时器管理**: 游戏暂停/退出时自动清理
- **UI清理**: 屏幕切换时正确释放资源

## 使用方法

### 1. 编译和烧录
```bash
# 设置ESP-IDF环境
idf.py set-target esp32s3

# 编译项目
idf.py build

# 烧录固件
idf.py -p COM3 flash monitor
```

### 2. 启动游戏
1. 开机后通过左右键切换到"飞行游戏"屏幕
2. 按中间键开始游戏
3. 使用左右键控制飞机移动
4. 自动发射子弹击落敌人

### 3. 退出游戏
- 长按中间键暂停
- 选择退出方式
- 自动返回正常屏幕切换模式

## 扩展开发

### 添加新功能
1. **新敌人类型**: 在`CreateEnemy()`中添加
2. **武器升级**: 修改`CreateBullet()`逻辑
3. **关卡系统**: 添加难度递增机制
4. **音效**: 集成音频系统

### 自定义配置
- 修改`flight_game_widget.h`中的常量
- 调整游戏速度、对象数量等参数
- 自定义UI颜色和字体

## 故障排除

### 常见问题
1. **按键无响应**: 检查触摸管理器初始化
2. **游戏卡顿**: 检查定时器优先级和内存
3. **显示异常**: 检查LVGL资源配置

### 调试信息
- 游戏状态切换日志
- 按键事件日志
- 对象创建/销毁日志

## 版本信息

- **目标芯片**: ESP32-S3
- **LVGL版本**: 9.x
- **ESP-IDF版本**: 5.x
- **项目版本**: xiaozhi-esp32 v2.0.5+

## 致谢

本项目基于xiaozhi-esp32框架开发，感谢原作者的贡献。飞行游戏组件采用模块化设计，便于维护和扩展。